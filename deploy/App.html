<!DOCTYPE html>
<html>
<head>
    <title>Iteration Burn down</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Iteration_BurndownApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"iteration",_burndownChartID:"burndownChart",launch:function(){this.add({xtype:"rallycheckboxfield",fieldLabel:"Scope in Story Points",id:"byStoryPointCheckBox",value:!1,listeners:{change:{fn:this._loadChart,scope:this}}}),this.onScopeChange()},onScopeChange:function(){this._loadCapacity().load().then({success:this._loadChart,scope:this}).then({success:function(){console.log("Woohoo!")},failure:function(t){console.log("ERROR! "+t)}})},_loadCapacity:function(){return Ext.create("Rally.data.wsapi.Store",{model:"UserIterationCapacity",fetch:["Capacity","Iteration"],pageSize:1e3})},_loadChart:function(t){var e=this.getContext().getTimeboxScope(),a=!1===this.down("#byStoryPointCheckBox").getValue();this.down("#burndownChart")&&this.remove("burndownChart");var o=0;for(i=0;i<t.length;i++)if(t[i].get("Iteration")._refObjectName===e.record.data.Name){var n=t[i].get("Capacity");null!=n&&(o+=n)}this.add({xtype:"rallychart",id:"burndownChart",storetype:"Rally.data.lookback.SnapshotStore",storeConfig:this._getStoreConfig(e),calculatorType:"IterationBurndownCalculator",calculatorConfig:{completedScheduleStateNames:["Accepted","Quality"],startDate:e.record.data.StartDate,endDate:e.record.data.EndDate,capacity:o,metrics:[{as:"ToDo",display:"line",f:"sum",field:"TaskRemainingTotal"},{as:"Scope",display:"area",f:a?"count":"sum",yAxis:1,field:a?null:"PlanEstimate"}]},chartConfig:this._getChartConfig(a)})},_getStoreConfig:function(t){return[{find:{$or:[{_TypeHierarchy:"HierarchicalRequirement"},{_TypeHierarchy:"Defect"}],Iteration:t.record.data.ObjectID},fetch:["TaskRemainingTotal","PlanEstimate"]}]},_getChartConfig:function(t){var e={title:{text:"Iteration Burndown"},xAxis:{tickmarkPlacement:"on"},yAxis:[{title:{text:"Hours"},min:0}],chart:{zoomType:"xy"}};return t?e.yAxis.push({title:{text:"Story Count"},opposite:!0}):e.yAxis.push({title:{text:"Story Points"},opposite:!0}),e}});
                Ext.define("IterationBurndownCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{completedScheduleStateNames:["Accepted","Quality"]},getWorkDays:function(){return["Monday","Tuesday","Wednesday","Thursday","Friday"]},getMetrics:function(){return this.config.metrics},getSummaryMetricsConfig:function(){return[{as:"InitialScope",f:function(t,e){for(var i=0,a=0;0===i&&a<t.length;)i=t[a].ToDo,a++;return i}},{as:"InitialCapacity",f:function(t,e){return 0}}]},getDerivedFieldsAfterSummary:function(){return[{as:"Ideal",f:function(t,e,i,a){const r=a.length-1,n=i.InitialScope/r;return Math.floor(i.InitialScope-n*e)},display:"line",dashStyle:"longdash"},{as:"Maximum",f:function(t,e,i,a){return i.InitialCapacity},display:"line",dashStyle:"shortdash",hidden:!0}]},runCalculation:function(t){const e=Ext.Date.format(new Date((new Date).getTime()+864e5),"Y-m-d\\TH:i:s")+".000Z";Ext.Array.forEach(t,function(t){"9999-01-01T00:00:00.000Z"===t._ValidTo&&(t._ValidTo=e)},this);var i=this._prepareCalculatorConfig(),a=this._buildSeriesConfig(i),r=this.prepareCalculator(i);return r.addSnapshots(t,this._getStartDate(t),this._getEndDate(t)),this._transformLumenizeDataToHighchartsSeries(r,a)},getProjectionsConfig:function(){return{continueWhile:function(t){return t.ToDo_projectoin>0},series:[{field:"ToDo"}]}},_transformLumenizeDataToHighchartsSeries:function(t,e){var i=t.getResults(),a=i.seriesData;a=this._calculateMaximumBurndown(a);var r={series:this.lumenize.arrayOfMaps_To_HighChartsSeries(a,e),categories:this._buildCategoriesFromData(a)};return this.enableProjections&&(r.projections=i.projections),r},_buildSeriesConfig:function(t){for(var e=[],i=t.metrics,a=t.deriveFieldsAfterSummary,r=0,n=i.length;r<n;r+=1){var o=i[r];e.push({name:o.as||o.field,type:o.display,dashStyle:o.dashStyle||"Solid",yAxis:o.yAxis||0})}for(var s=0,l=a.length;s<l;s+=1){var u=a[s];e.push({name:u.as,type:u.display,dashStyle:u.dashStyle||"Solid",yAxis:u.yAxis||0})}return e},_calculateMaximumBurndown:function(t){const e=t.length-1,a=this.capacity/e;for(i=0;i<t.length;i++)t[i].Maximum=Math.floor(this.capacity-a*i);return t}});
                Ext.define("TroubleShootingChart",{extend:"Rally.ui.chart.Chart",_haveDataToRender:function(){var a=this.chartData.series;console.log("chartData",this.chartData);for(var t=0,r=a.length;t<r;t++)for(var e=a[t].data,h=0,i=e.length;h<i;h++){if(this._isData(e[h]))return!0;if(Ext.isArray(e[h])&&_.some(e[h],this._isData))return!0}}});

            Rally.launchApp('Iteration_BurndownApp', {
                name:"Iteration Burn down",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
