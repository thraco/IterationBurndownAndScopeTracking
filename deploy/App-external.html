<!DOCTYPE html>
<html>
<head>
    <title>Iteration Burn down</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Iteration_BurndownApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"iteration",_burndownChartID:"burndownChart",launch:function(){this.add({xtype:"rallycheckboxfield",fieldLabel:"Scope in Story Points",id:"byStoryPointCheckBox",value:!1,listeners:{change:{fn:this._loadChart,scope:this}}}),this._loadChart()},onScopeChange:function(){this._loadChart()},_loadChart:function(){var scope=this.getContext().getTimeboxScope(),burnByCount=this.down("#byStoryPointCheckBox").getValue()===!1;this.down("#burndownChart")&&this.remove("burndownChart"),this.add({xtype:"rallychart",id:"burndownChart",storetype:"Rally.data.lookback.SnapshotStore",storeConfig:this._getStoreConfig(scope),calculatorType:"IterationBurndownCalculator",calculatorConfig:{completedScheduleStateNames:["Accepted","Quality"],startDate:scope.record.data.StartDate,endDate:scope.record.data.EndDate,metrics:[{as:"ToDo",display:"line",f:"sum",field:"TaskRemainingTotal"},{as:"Scope",display:"area",f:burnByCount?"count":"sum",yAxis:1,field:burnByCount?null:"PlanEstimate"}]},chartConfig:this._getChartConfig(burnByCount)})},_getStoreConfig:function(scope){return[{find:{$or:[{_TypeHierarchy:"HierarchicalRequirement"},{_TypeHierarchy:"Defect"}],Iteration:scope.record.data.ObjectID},fetch:["TaskRemainingTotal","PlanEstimate"]}]},_getChartConfig:function(burnByCount){var config={title:{text:"Iteration Burndown"},xAxis:{tickmarkPlacement:"on"},yAxis:[{title:{text:"Hours"},min:0}],chart:{zoomType:"xy"}};return burnByCount?config.yAxis.push({title:{text:"Story Count"},opposite:!0}):config.yAxis.push({title:{text:"Story Points"},opposite:!0}),config}});
                Ext.define("IterationBurndownCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{completedScheduleStateNames:["Accepted","Quality"]},getWorkDays:function(){return["Monday","Tuesday","Wednesday","Thursday","Friday"]},getMetrics:function(){return this.config.metrics},getSummaryMetricsConfig:function(){return[{as:"InitialScope",f:function(seriesData,summaryMetrics){for(var initialScope=0,index=0;0===initialScope&&seriesData.length>index;)initialScope=seriesData[index].ToDo,index++;return initialScope}}]},getDerivedFieldsAfterSummary:function(){return[{as:"Ideal",f:function(row,index,summaryMetrics,seriesData){const iterationLength=seriesData.length-1,incrementAmountPerDay=summaryMetrics.InitialScope/iterationLength;return Math.floor(summaryMetrics.InitialScope-incrementAmountPerDay*index)},display:"line",dashStyle:"longdash"}]},runCalculation:function(snapshots){const tomorrow=Ext.Date.format(new Date((new Date).getTime()+864e5),"Y-m-d\\TH:i:s")+".000Z";Ext.Array.forEach(snapshots,function(s){"9999-01-01T00:00:00.000Z"===s._ValidTo&&(s._ValidTo=tomorrow)},this);var calculatorConfig=this._prepareCalculatorConfig(),seriesConfig=this._buildSeriesConfig(calculatorConfig),calculator=this.prepareCalculator(calculatorConfig);return calculator.addSnapshots(snapshots,this._getStartDate(snapshots),this._getEndDate(snapshots)),this._transformLumenizeDataToHighchartsSeries(calculator,seriesConfig)},getProjectionsConfig:function(){return{continueWhile:function(point){return point.ToDo_projectoin>0},series:[{field:"ToDo"}]}},_transformLumenizeDataToHighchartsSeries:function(calculator,seriesConfig){var results=calculator.getResults(),seriesData=results.seriesData,finalData={series:this.lumenize.arrayOfMaps_To_HighChartsSeries(seriesData,seriesConfig),categories:this._buildCategoriesFromData(seriesData)};return this.enableProjections&&(finalData.projections=results.projections),finalData},_buildSeriesConfig:function(calculatorConfig){for(var aggregationConfig=[],metrics=calculatorConfig.metrics,derivedFieldsAfterSummary=calculatorConfig.deriveFieldsAfterSummary,i=0,ilength=metrics.length;ilength>i;i+=1){var metric=metrics[i];aggregationConfig.push({name:metric.as||metric.field,type:metric.display,dashStyle:metric.dashStyle||"Solid",yAxis:metric.yAxis||0})}for(var j=0,jlength=derivedFieldsAfterSummary.length;jlength>j;j+=1){var derivedField=derivedFieldsAfterSummary[j];aggregationConfig.push({name:derivedField.as,type:derivedField.display,dashStyle:derivedField.dashStyle||"Solid",yAxis:derivedField.yAxis||0})}return aggregationConfig}});
                Ext.define("TroubleShootingChart",{extend:"Rally.ui.chart.Chart",_haveDataToRender:function(){var seriesData=this.chartData.series;console.log("chartData",this.chartData);for(var i=0,ilength=seriesData.length;ilength>i;i++)for(var data=seriesData[i].data,j=0,jlength=data.length;jlength>j;j++){if(this._isData(data[j]))return!0;if(Ext.isArray(data[j])&&_.some(data[j],this._isData))return!0}}});

            Rally.launchApp('Iteration_BurndownApp', {
                name:"Iteration Burn down",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
